<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inbox - Roomio</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles/site.css">
    
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 260px;
        background: white;
        border-right: 1px solid #e5e7eb;
        z-index: 1000;
        transition: transform 0.3s ease;
      }

      @media (max-width: 991px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .sidebar.show {
          transform: translateX(0);
        }
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .sidebar-overlay.show {
        display: block;
      }

      .main-content {
        margin-left: 260px;
        min-height: 100vh;
      }

      @media (max-width: 991px) {
        .main-content {
          margin-left: 0;
        }
      }

      .nav-link-custom {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        color: #6b7280;
        text-decoration: none;
        border-radius: 0.5rem;
        margin-bottom: 0.25rem;
        transition: all 0.2s;
      }

      .nav-link-custom:hover {
        background: #f3f4f6;
        color: #1f2937;
      }

      .nav-link-custom.active {
        background: #e5e7eb;
        color: #1f2937;
      }

      .nav-link-custom i {
        margin-right: 0.75rem;
        width: 20px;
      }

      .mobile-header {
        display: none;
        position: sticky;
        top: 0;
        z-index: 998;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem;
      }

      @media (max-width: 991px) {
        .mobile-header {
          display: flex;
        }
      }

      .conversation-list {
        border-right: 1px solid #e5e7eb;
        height: calc(100vh - 80px);
        overflow-y: auto;
      }

      .conversation-item {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        transition: background 0.2s;
      }

      .conversation-item:hover {
        background: #f9fafb;
      }

      .conversation-item.active {
        background: #eff6ff;
        border-left: 3px solid #2563eb;
      }

      .chat-container {
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: #f9fafb;
      }

      .message {
        margin-bottom: 1rem;
        display: flex;
        gap: 0.75rem;
      }

      .message.sent {
        flex-direction: row-reverse;
      }

      .message-content {
        max-width: 60%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
      }

      .message.received .message-content {
        background: white;
      }

      .message.sent .message-content {
        background: #2563eb;
        color: white;
      }

      .chat-input {
        padding: 1rem;
        border-top: 1px solid #e5e7eb;
        background: white;
      }
    </style>
  </head>
  <body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="p-4">
        <div class="d-flex align-items-center">
          <i class="bi bi-building text-primary fs-2 me-2"></i>
          <h4 class="mb-0 text-primary">Roomio</h4>
        </div>
      </div>

      <nav class="px-3">
        <a href="index.html" class="nav-link-custom">
          <i class="bi bi-house-door"></i>
          Beranda
        </a>
        <a href="search.html" class="nav-link-custom">
          <i class="bi bi-search"></i>
          Cari Kos
        </a>
        <a href="inbox.html" class="nav-link-custom active">
          <i class="bi bi-chat-dots"></i>
          Pesan
        </a>
        <a href="user-dashboard.html" class="nav-link-custom">
          <i class="bi bi-heart"></i>
          Favorit & Booking
        </a>

        <div id="hostNavLinks" class="d-none">
          <div class="pt-3 pb-2 px-3 text-muted small">PEMILIK</div>
          <a href="host-dashboard.html" class="nav-link-custom">
            <i class="bi bi-building"></i>
            Dashboard Host
          </a>
          <a href="create-listing.html" class="nav-link-custom">
            <i class="bi bi-plus-circle"></i>
            Tambah Listing
          </a>
        </div>
      </nav>

      <div class="position-absolute bottom-0 start-0 end-0 p-3 border-top">
        <a href="profile.html" class="nav-link-custom mb-2">
          <i class="bi bi-person"></i>
          <span id="userName">User</span>
        </a>
        <button class="btn btn-outline-secondary w-100" onclick="logout()">Keluar</button>
      </div>
    </aside>

    <main class="main-content">
      <div class="mobile-header">
        <button class="btn btn-link text-dark" onclick="toggleSidebar()">
          <i class="bi bi-list fs-4"></i>
        </button>
        <div class="d-flex align-items-center mx-auto">
          <i class="bi bi-building text-primary fs-5 me-2"></i>
          <h5 class="mb-0 text-primary">Roomio</h5>
        </div>
        <div style="width: 40px"></div>
      </div>

      <div class="row g-0">
        <!-- Conversation List -->
        <div class="col-md-4 col-lg-3">
          <div class="conversation-list">
            <div class="p-3 border-bottom">
              <h5 class="mb-0">Pesan</h5>
            </div>
            <div id="conversationList">
              <!-- Conversations will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-8 col-lg-9">
          <div id="chatArea" class="d-none">
            <div class="chat-container">
              <!-- Chat Header -->
              <div class="p-3 border-bottom bg-white">
                <div class="d-flex align-items-center">
                  <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px">
                    <span id="chatUserInitial">I</span>
                  </div>
                  <div>
                    <h6 class="mb-0" id="chatUserName">Ibu Siti</h6>
                    <small class="text-muted">Online</small>
                  </div>
                </div>
              </div>

              <!-- Messages -->
              <div class="chat-messages" id="chatMessages">
                <!-- Messages will be loaded here -->
              </div>

              <!-- Input -->
              <div class="chat-input">
                <div class="input-group">
                  <input type="text" class="form-control" id="messageInput" placeholder="Ketik pesan..." />
                  <button class="btn btn-primary" onclick="sendMessage()"><i class="bi bi-send"></i> Kirim</button>
                </div>
              </div>
            </div>
          </div>

          <div id="noChat" class="d-flex align-items-center justify-content-center h-100">
            <div class="text-center">
              <i class="bi bi-chat-dots fs-1 text-muted mb-3"></i>
              <h5 class="text-muted">Pilih percakapan untuk mulai chat</h5>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/listings.js"></script>
    <script>
      if (!requireAuth()) {
        // redirected by requireAuth()
      }

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        sidebar.classList.toggle("show");
        overlay.classList.toggle("show");
      }

      document.getElementById("sidebarOverlay").addEventListener("click", toggleSidebar);

      // Request notification permission
      function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission === "default") {
          Notification.requestPermission();
        }
      }

      // Show notification
      function showNotification(title, body, icon = null) {
        if ("Notification" in window && Notification.permission === "granted") {
          const notification = new Notification(title, {
            body: body,
            icon: icon || "https://cdn-icons-png.flaticon.com/512/1828/1828884.png",
            badge: "https://cdn-icons-png.flaticon.com/512/1828/1828884.png",
            tag: "roomio-message",
            requireInteraction: false,
            vibrate: [200, 100, 200],
          });

          // Auto close after 5 seconds
          setTimeout(() => notification.close(), 5000);

          // Click notification to focus window
          notification.onclick = function () {
            window.focus();
            notification.close();
          };
        }
      }

      // Mock conversations
      const conversations = [
        {
          id: "1",
          user: "Ibu Siti",
          lastMessage: "Baik, silakan datang besok untuk survey",
          time: "10 menit yang lalu",
          unread: 1,
          messages: [
            { sender: "received", text: "Halo, ada yang bisa saya bantu?", time: "10:00" },
            { sender: "sent", text: "Selamat pagi, saya tertarik dengan kos Anda", time: "10:05" },
            { sender: "received", text: "Baik, silakan datang besok untuk survey", time: "10:10" },
          ],
        },
        {
          id: "2",
          user: "Pak Budi",
          lastMessage: "Terima kasih atas infonya",
          time: "1 jam yang lalu",
          unread: 0,
          messages: [
            { sender: "received", text: "Ada kamar yang masih tersedia?", time: "09:00" },
            { sender: "sent", text: "Masih ada 2 kamar tersedia", time: "09:15" },
            { sender: "received", text: "Terima kasih atas infonya", time: "09:20" },
          ],
        },
      ];

      let currentConversation = null;

      function loadConversations() {
        const container = document.getElementById("conversationList");

        container.innerHTML = conversations
          .map(
            (conv) => `
                <div class="conversation-item ${conv.id === "1" ? "active" : ""}" onclick="openChat('${conv.id}')">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong>${conv.user}</strong>
                        <small class="text-muted">${conv.time}</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="text-muted small mb-0 text-truncate" style="max-width: 200px;">${conv.lastMessage}</p>
                        ${conv.unread > 0 ? `<span class="badge bg-primary rounded-pill">${conv.unread}</span>` : ""}
                    </div>
                </div>
            `
          )
          .join("");

        // Open first conversation by default
        if (conversations.length > 0) {
          openChat("1");
        }
      }

      function openChat(id) {
        currentConversation = conversations.find((c) => c.id === id);

        if (!currentConversation) return;

        // Update UI
        document.getElementById("noChat").classList.add("d-none");
        document.getElementById("chatArea").classList.remove("d-none");

        // Update conversation list active state
        document.querySelectorAll(".conversation-item").forEach((item) => {
          item.classList.remove("active");
        });
        event.currentTarget.classList.add("active");

        // Update chat header
        document.getElementById("chatUserName").textContent = currentConversation.user;
        document.getElementById("chatUserInitial").textContent = currentConversation.user.charAt(0);

        // Load messages
        loadMessages();
      }

      function loadMessages() {
        const container = document.getElementById("chatMessages");

        container.innerHTML = currentConversation.messages
          .map(
            (msg) => `
                <div class="message ${msg.sender}">
                    ${
                      msg.sender === "received"
                        ? `
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 40px; height: 40px; min-width: 40px;">
                            <span>${currentConversation.user.charAt(0)}</span>
                        </div>
                    `
                        : ""
                    }
                    <div>
                        <div class="message-content">
                            <p class="mb-1">${msg.text}</p>
                            <small class="opacity-75">${msg.time}</small>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const text = input.value.trim();

        if (!text || !currentConversation) return;

        // Add message
        currentConversation.messages.push({
          sender: "sent",
          text: text,
          time: new Date().toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" }),
        });

        // Update last message
        currentConversation.lastMessage = text;
        currentConversation.time = "Baru saja";

        // Show notification for sent message
        showNotification("âœ“ Pesan Terkirim", `Pesan Anda kepada ${currentConversation.user} telah terkirim`);

        // Clear input
        input.value = "";

        // Reload
        loadMessages();

        // Simulate reply after 2 seconds
        setTimeout(() => {
          currentConversation.messages.push({
            sender: "received",
            text: "Terima kasih atas pesannya. Saya akan segera merespons.",
            time: new Date().toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" }),
          });
          loadMessages();

          // Show notification for received message
          showNotification(`ðŸ’¬ Pesan Baru dari ${currentConversation.user}`, "Terima kasih atas pesannya. Saya akan segera merespons.");
        }, 2000);
      }

      // Send message on Enter
      document.getElementById("messageInput").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        updateAuthUI();
        loadConversations();
        requestNotificationPermission();
      });
    </script>
  </body>
</html>
