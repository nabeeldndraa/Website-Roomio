<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Roomio</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-color: #2563eb;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f9fafb;
        }
        .mobile-spacer { width: 40px; }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: white;
            border-right: 1px solid #e5e7eb;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        @media (max-width: 991px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.show {
                transform: translateX(0);
            }
        }
        
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }
        
        @media (max-width: 991px) {
            .main-content {
                margin-left: 0;
            }
        }
        
        .stat-card {
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .listing-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        
        .listing-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="p-4 border-bottom">
            <div class="d-flex align-items-center">
                <i class="bi bi-shield-check text-danger fs-2 me-2"></i>
                <div>
                    <h5 class="mb-0 text-danger">Admin Panel</h5>
                    <small class="text-muted">Roomio</small>
                </div>
            </div>
        </div>

        <!-- Transactions placeholder (moved to main content so it shows) -->
        
        <nav class="px-3 py-3">
            <a href="#dashboard" class="nav-link active mb-2" onclick="showSection('dashboard', event)">
                <i class="bi bi-speedometer2 me-2"></i>
                Dashboard
            </a>
            <a href="#pending" class="nav-link mb-2" onclick="showSection('pending', event)">
                <i class="bi bi-clock-history me-2"></i>
                Listing Pending
                <span class="badge bg-warning ms-auto" id="pendingCount">0</span>
            </a>
            <a href="#listings" class="nav-link mb-2" onclick="showSection('listings', event)">
                <i class="bi bi-building me-2"></i>
                Semua Listing
            </a>
            <a href="#users" class="nav-link mb-2" onclick="showSection('users', event)">
                <i class="bi bi-people me-2"></i>
                Pengguna
            </a>
            <a href="#transactions" class="nav-link mb-2" onclick="showSection('transactions', event)">
                <i class="bi bi-receipt me-2"></i>
                Transaksi
                <span class="badge bg-info ms-auto" id="txnPendingCount">0</span>
            </a>
        </nav>
        
        <div class="position-absolute bottom-0 start-0 end-0 p-3 border-top">
            <a href="index.html" class="btn btn-outline-secondary w-100 mb-2">
                <i class="bi bi-arrow-left me-2"></i>
                Ke Website
            </a>
            <button class="btn btn-danger w-100" onclick="logout()">
                <i class="bi bi-box-arrow-right me-2"></i>
                Keluar
            </button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Header -->
        <div class="d-lg-none bg-white border-bottom p-3">
            <div class="d-flex align-items-center justify-content-between">
                <button class="btn btn-link" aria-label="Toggle navigation" onclick="toggleSidebar()">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <h5 class="mb-0">Admin Panel</h5>
                <div class="mobile-spacer"></div>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section-content">
            <div class="p-4">
                <h2 class="mb-4">Dashboard Admin</h2>
                
                <!-- Stats Cards -->
                <div class="row g-4 mb-5">
                    <div class="col-md-3">
                        <div class="stat-card bg-primary bg-gradient text-white p-4">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-white-50 small mb-1">Total Pengguna</div>
                                    <h3 class="mb-0" id="statUsers">0</h3>
                                </div>
                                <i class="bi bi-people fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="stat-card bg-warning bg-gradient text-white p-4">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-white-50 small mb-1">Pending</div>
                                    <h3 class="mb-0" id="statPending">0</h3>
                                </div>
                                <i class="bi bi-clock-history fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="stat-card bg-success bg-gradient text-white p-4">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-white-50 small mb-1">Disetujui</div>
                                    <h3 class="mb-0" id="statApproved">0</h3>
                                </div>
                                <i class="bi bi-check-circle fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="stat-card bg-danger bg-gradient text-white p-4">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="text-white-50 small mb-1">Ditolak</div>
                                    <h3 class="mb-0" id="statRejected">0</h3>
                                </div>
                                <i class="bi bi-x-circle fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chart Visualization -->
                    <div class="card mb-4">
                <div class="card-header bg-white">
                     <h5 class="mb-0">Visualisasi Status Listing</h5>
            </div>
            <div class="card-body">
        <canvas id="listingChart" height="120"></canvas>
    </div>
</div>

<!-- Container Bar Chart -->
<div class="card mb-4">
<div class="card-header bg-white">
<h5 class="mb-0">Statistik Listing per Kategori</h5>
</div>
<div class="card-body">
<canvas id="barChart" height="120"></canvas>
</div>
</div>


<!-- Container Map -->
<div class="card mb-4">
<div class="card-header bg-white">
<h5 class="mb-0">Peta Lokasi Properti</h5>
</div>
<div class="card-body">
<div id="map" style="height: 350px; width: 100%; border-radius: 10px;"></div>
</div>
</div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Aktivitas Terbaru</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Fitur aktivitas akan segera ditambahkan</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pending Listings Section -->
        <div id="pendingSection" class="section-content d-none">
            <div class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Listing Pending</h2>
                    <button class="btn btn-outline-secondary" onclick="loadPendingListings()">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Refresh
                    </button>
                </div>
                
                <div id="pendingListingsContainer">
                    <!-- Pending listings will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- All Listings Section -->
        <div id="listingsSection" class="section-content d-none">
            <div class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Semua Listing</h2>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" onclick="filterListings('')">Semua</button>
                        <button class="btn btn-outline-warning" onclick="filterListings('pending')">Pending</button>
                        <button class="btn btn-outline-success" onclick="filterListings('approved')">Disetujui</button>
                        <button class="btn btn-outline-danger" onclick="filterListings('rejected')">Ditolak</button>
                    </div>
                </div>
                
                <div id="allListingsContainer">
                    <!-- All listings will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Users Section -->
        <div id="usersSection" class="section-content d-none">
            <div class="p-4">
                <h2 class="mb-4">Manajemen Pengguna</h2>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Nama</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Bergabung</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Section (moved from sidebar so it appears in main content) -->
        <div id="transactionsSection" class="section-content d-none">
            <div class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Transaksi</h2>
                    <div>
                        <button class="btn btn-outline-secondary me-2" onclick="loadTransactions()">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Refresh
                        </button>
                        <button class="btn btn-outline-primary" onclick="openFeeSettings()">
                            <i class="bi bi-gear me-1"></i>
                            Pengaturan Fee
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="transactionsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Penyewa</th>
                                        <th>Pemilik</th>
                                        <th>Listing</th>
                                        <th>Jumlah</th>
                                        <th>Fee Admin</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody">
                                    <!-- Transactions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Konfirmasi Persetujuan</h5>
                    <button type="button" class="btn-close" aria-label="Close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Apakah Anda yakin ingin menyetujui listing ini?</p>
                    <p class="text-muted small">Listing akan langsung muncul di pencarian setelah disetujui.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-success" onclick="confirmApprove()">
                        <i class="bi bi-check-circle me-2"></i>
                        Setujui
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rejection Modal -->
    <div class="modal fade" id="rejectionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tolak Listing</h5>
                    <button type="button" class="btn-close" aria-label="Close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Alasan Penolakan *</label>
                        <textarea class="form-control" id="rejectionReason" rows="4" 
                                  placeholder="Masukkan alasan penolakan yang jelas..."></textarea>
                    </div>
                    <p class="text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        Alasan akan dikirim ke pemilik listing melalui notifikasi.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" onclick="confirmReject()">
                        <i class="bi bi-x-circle me-2"></i>
                        Tolak Listing
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CDN Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- CDN Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ================= BAR CHART =====================
function loadBarChart() {
    const ctx = document.getElementById('barChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Kos Putra', 'Kos Putri', 'Kos Campur', 'Kontrakan'],
            datasets: [{
                label: 'Jumlah Listing',
                data: [12, 20, 8, 5], // contoh data
                backgroundColor: ['#3b82f6', '#10b981', '#facc15', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}
// ================= BAR CHART =====================
function loadBarChart() {
const ctx = document.getElementById('barChart').getContext('2d');


new Chart(ctx, {
type: 'bar',
data: {
labels: ['Kos Putra', 'Kos Putri', 'Kos Campur', 'Kontrakan'],
datasets: [{
label: 'Jumlah Listing',
data: [12, 20, 8, 5], // contoh data
backgroundColor: ['#3b82f6', '#10b981', '#facc15', '#ef4444']
}]
},
options: {
responsive: true,
scales: {
y: { beginAtZero: true }
}
}
});
}


// ================= MAP LEAFLET ====================
function loadMap() {
// Set posisi awal peta (contoh: Jakarta)
const map = L.map('map').setView([-6.200000, 106.816666], 11);


L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 18,
}).addTo(map);


// Contoh titik properti
const properties = [
{ name: 'Kos Putra Harmoni', lat: -6.203, lng: 106.820 },
{ name: 'Kos Putri Mawar', lat: -6.190, lng: 106.830 },
{ name: 'Kontrakan Bunga', lat: -6.210, lng: 106.810 }
];


properties.forEach(p => {
L.marker([p.lat, p.lng]).addTo(map)
.bindPopup(`<b>${p.name}</b>`);
});
}


// Panggil fungsi ketika halaman load
window.onload = function() {
loadBarChart();
loadMap();
};

</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/notifications.js"></script>
    
    <script>
        let currentListingId = null;
        let approvalModal, rejectionModal, badgeModal, feeModal, txnVerifyModal;
        let currentTxnId = null;

        // Simple mock state - replace with API integration later
        let adminFeePercent = 5; // default admin fee %
        const listingBadges = {}; // map listingId -> { badge, highlight }
        const listingFees = {}; // map listingId -> fee (fixed Rp)

        const mockTransactions = [
            { id: 'T-3001', renter: 'Sari', owner: 'Agus', listing: 'Kos Modern 101', amount: 1500000, fee: 75000, status: 'pending' },
            { id: 'T-3002', renter: 'Rian', owner: 'Ika', listing: 'Apartemen A', amount: 3000000, fee: 150000, status: 'verified' }
        ];
        
        // Check if user is admin
        const user = getCurrentUser();
        if (!user || user.role !== 'admin') {
            notify.error('Anda harus login sebagai admin untuk mengakses halaman ini', 'Akses Ditolak');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }
        
        // Initialize modals
        document.addEventListener('DOMContentLoaded', function() {
            approvalModal = new bootstrap.Modal(document.getElementById('approvalModal'));
            rejectionModal = new bootstrap.Modal(document.getElementById('rejectionModal'));
            badgeModal = new bootstrap.Modal(document.getElementById('badgeModal'));
            feeModal = new bootstrap.Modal(document.getElementById('feeModal'));
            txnVerifyModal = new bootstrap.Modal(document.getElementById('txnVerifyModal'));

            loadDashboardStats();
            let listingChart = null;

            function loadDashboardStats() {
    const stats = {
        total_users: 145,
        listings: {
            pending: 8,
            approved: 42,
            rejected: 3,
            archived: 2
        }
    };

    document.getElementById('statUsers').textContent = stats.total_users;
    document.getElementById('statPending').textContent = stats.listings.pending;
    document.getElementById('statApproved').textContent = stats.listings.approved;
    document.getElementById('statRejected').textContent = stats.listings.rejected;
    document.getElementById('pendingCount').textContent = stats.listings.pending;

    // ⭐ Tampilkan Chart
    renderChart(stats);
}
            loadPendingListings();
            loadTransactions();
        });
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }
        
        function showSection(section, evt) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(s => s.classList.add('d-none'));
            
            // Show selected section
            document.getElementById(section + 'Section').classList.remove('d-none');
            
            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            // prefer the passed event (evt) and fall back to global if available
            try {
                const usedEvent = evt || window.event;
                const activeEl = usedEvent && usedEvent.target ? usedEvent.target.closest('.nav-link') : null;
                if (activeEl) activeEl.classList.add('active');
            } catch (e) { /* ignore */ }

            // On small screens, hide sidebar after navigation so user returns to content
            if (window.innerWidth <= 991) {
                document.getElementById('sidebar').classList.remove('show');
            }
            
            // Load data based on section
            if (section === 'pending') {
                loadPendingListings();
            } else if (section === 'listings') {
                filterListings('');
            } else if (section === 'users') {
                loadUsers();
            } else if (section === 'transactions') {
                loadTransactions();
            }
        }
        
        // Load dashboard statistics
        function loadDashboardStats() {
            // Mock data - replace with actual API call
            const stats = {
                total_users: 145,
                listings: {
                    pending: 8,
                    approved: 42,
                    rejected: 3,
                    archived: 2
                }
            };
            
            document.getElementById('statUsers').textContent = stats.total_users;
            document.getElementById('statPending').textContent = stats.listings.pending;
            document.getElementById('statApproved').textContent = stats.listings.approved;
            document.getElementById('statRejected').textContent = stats.listings.rejected;
            document.getElementById('pendingCount').textContent = stats.listings.pending;
        }
        
        // Load pending listings
        function loadPendingListings() {
            const container = document.getElementById('pendingListingsContainer');
            
            // Mock data - replace with actual API call to api/admin.php?action=pending
            const pendingListings = [
                {
                    id: '101',
                    title: 'Kos Modern Strategis di Pusat Kota',
                    owner_name: 'Budi Santoso',
                    owner_email: 'budi@example.com',
                    category: 'kos-putra',
                    price: 1500000,
                    address: 'Jl. Sudirman No. 45, Kaliwates',
                    created_at: '2024-11-18 10:30:00',
                    image: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400'
                }
            ];
            
            if (pendingListings.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-check-circle text-success fs-1 mb-3"></i>
                        <h5>Tidak Ada Listing Pending</h5>
                        <p class="text-muted">Semua listing sudah diproses</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pendingListings.map(listing => `
                <div class="listing-card mb-3">
                    <div class="row g-0">
                        <div class="col-md-3">
                            <img src="${listing.image}" class="img-fluid rounded-start h-100 object-fit-cover" alt="${listing.title}">
                        </div>
                        <div class="col-md-9">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="card-title mb-1">${listing.title} ${listingBadges[listing.id] ? (`<span class="badge bg-info ms-2 text-dark">${listingBadges[listing.id].badge.replace('_',' ')}</span>`) : ''}</h5>
                                        <p class="text-muted small mb-2">
                                            <i class="bi bi-person me-1"></i> ${listing.owner_name}
                                            <span class="mx-2">•</span>
                                            <i class="bi bi-envelope me-1"></i> ${listing.owner_email}
                                        </p>
                                    </div>
                                    <span class="status-badge status-pending">
                                        <i class="bi bi-clock-history me-1"></i>
                                        Pending
                                    </span>
                                </div>
                                
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Kategori</small>
                                        <span class="badge bg-light text-dark">${listing.category}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Harga</small>
                                        <strong class="text-primary">Rp ${listing.price.toLocaleString('id-ID')}</strong>/bulan
                                        <div class="small text-muted mt-1">Fee admin: ${adminFeePercent}% ${listingFees[listing.id] ? `• Fee listing: Rp ${listingFees[listing.id].toLocaleString('id-ID')}` : ''}</div>
                                    </div>
                                </div>
                                
                                <p class="small text-muted mb-3">
                                    <i class="bi bi-geo-alt me-1"></i>
                                    ${listing.address}
                                </p>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success btn-sm" onclick="showApprovalModal('${listing.id}')">
                                        <i class="bi bi-check-circle me-1"></i>
                                        Setujui
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="showRejectionModal('${listing.id}')">
                                        <i class="bi bi-x-circle me-1"></i>
                                        Tolak
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showBadgeModal('${listing.id}')">
                                        <i class="bi bi-award me-1"></i>
                                        Tambah Badge
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="showFeeModal('${listing.id}')">
                                        <i class="bi bi-cash-stack me-1"></i>
                                        Set Fee
                                    </button>
                                    <a href="listing-detail.html?id=${listing.id}" class="btn btn-outline-primary btn-sm" target="_blank">
                                        <i class="bi bi-eye me-1"></i>
                                        Lihat Detail
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Show approval modal
        function showApprovalModal(listingId) {
            currentListingId = listingId;
            approvalModal.show();
        }
        
        // Show rejection modal
        function showRejectionModal(listingId) {
            currentListingId = listingId;
            document.getElementById('rejectionReason').value = '';
            rejectionModal.show();
        }
        
        // Confirm approve
        function confirmApprove() {
            if (!currentListingId) return;
            
            // Mock approval - replace with actual API call
            console.log('Approving listing:', currentListingId);
            
            notify.success('Listing berhasil disetujui!', 'Berhasil!');
            approvalModal.hide();
            
            setTimeout(() => {
                loadDashboardStats();
                loadPendingListings();
            }, 500);
        }
        
        // Confirm reject
        function confirmReject() {
            const reason = document.getElementById('rejectionReason').value;
            
            if (!reason.trim()) {
                notify.warning('Mohon masukkan alasan penolakan', 'Alasan Diperlukan');
                return;
            }
            
            if (!currentListingId) return;
            
            // Mock rejection - replace with actual API call
            console.log('Rejecting listing:', currentListingId, 'Reason:', reason);
            
            notify.success('Listing berhasil ditolak', 'Berhasil!');
            rejectionModal.hide();
            
            setTimeout(() => {
                loadDashboardStats();
                loadPendingListings();
            }, 500);
        }

        // Show badge modal for specific listing
        function showBadgeModal(listingId) {
            currentListingId = listingId;
            // prefill if already exists
            const b = listingBadges[listingId];
            document.getElementById('badgeSelect').value = b ? b.badge : '';
            document.getElementById('badgeHighlight').checked = b ? !!b.highlight : true;
            badgeModal.show();
        }

        function assignBadge() {
            const badge = document.getElementById('badgeSelect').value;
            const highlight = document.getElementById('badgeHighlight').checked;
            if (!badge) {
                notify.warning('Pilih badge dahulu', 'Tidak ada badge');
                return;
            }
            listingBadges[currentListingId] = { badge, highlight };
            notify.success('Badge disimpan untuk listing', 'Berhasil');
            badgeModal.hide();
            // re-render
            loadPendingListings();
            filterListings('');
        }

        // Fee handling
        function openFeeSettings() {
            currentListingId = null; // global
            document.getElementById('adminFeeInput').value = adminFeePercent;
            document.getElementById('listingFeeInput').value = '';
            feeModal.show();
        }

        function showFeeModal(listingId) {
            currentListingId = listingId;
            // prefill listing fee if set
            document.getElementById('listingFeeInput').value = listingFees[listingId] || '';
            document.getElementById('adminFeeInput').value = adminFeePercent;
            feeModal.show();
        }

        function saveFeeSettings() {
            const adminFee = parseFloat(document.getElementById('adminFeeInput').value || adminFeePercent);
            const listingFee = parseFloat(document.getElementById('listingFeeInput').value || 0);
            if (!isNaN(adminFee)) adminFeePercent = adminFee;

            if (currentListingId) {
                if (!isNaN(listingFee) && listingFee > 0) listingFees[currentListingId] = listingFee;
                notify.success('Fee listing disimpan', 'Berhasil');
            } else {
                notify.success('Fee admin disimpan', 'Berhasil');
            }
            feeModal.hide();
            // update UI
            loadPendingListings();
            loadTransactions();
        }

        // Transactions
        function loadTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            const pendingCount = mockTransactions.filter(t => t.status === 'pending').length;
            document.getElementById('txnPendingCount').textContent = pendingCount;

            tbody.innerHTML = mockTransactions.map(txn => {
                const computedFee = txn.fee ? txn.fee : Math.round(txn.amount * adminFeePercent / 100);
                return `
                <tr>
                    <td>${txn.id}</td>
                    <td>${txn.renter}</td>
                    <td>${txn.owner}</td>
                    <td>${txn.listing}</td>
                    <td>Rp ${txn.amount.toLocaleString('id-ID')}</td>
                    <td>Rp ${computedFee.toLocaleString('id-ID')}</td>
                    <td><span class="badge bg-${txn.status === 'pending' ? 'warning' : txn.status === 'verified' ? 'success' : 'secondary'} text-dark">${txn.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showTxnVerifyModal('${txn.id}')">Verifikasi</button>
                    </td>
                </tr>
            `; }).join('');
        }

        function showTxnVerifyModal(txnId) {
            currentTxnId = txnId;
            const txn = mockTransactions.find(t => t.id === txnId);
            if (!txn) return;
            document.getElementById('txnVerifyBody').textContent = `Transaksi ${txn.id} — ${txn.listing} (Rp ${txn.amount.toLocaleString('id-ID')})`;
            document.getElementById('txnStatusSelect').value = txn.status;
            txnVerifyModal.show();
        }

        function confirmVerifyTransaction() {
            if (!currentTxnId) return;
            const newStatus = document.getElementById('txnStatusSelect').value;
            const txn = mockTransactions.find(t => t.id === currentTxnId);
            if (!txn) return;
            txn.status = newStatus;
            notify.success('Status transaksi diperbarui', 'Berhasil');
            txnVerifyModal.hide();
            loadTransactions();
        }
        
        // Filter listings
        function filterListings(status) {
            const container = document.getElementById('allListingsContainer');
            container.innerHTML = '<p class="text-center py-5">Loading...</p>';

            // Mock - replace with actual API call
            setTimeout(() => {
                const all = [
                    { id: '101', title: 'Kos Modern Strategis di Pusat Kota', owner_name: 'Budi Santoso', category: 'kos-putra', price: 1500000, status: 'pending', image: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=400' },
                    { id: '102', title: 'Apartemen Minimalis Dekat Kampus', owner_name: 'Ika H.', category: 'apartemen', price: 2200000, status: 'approved', image: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400' }
                ];

                const filtered = status ? all.filter(l => l.status === status) : all;

                if (filtered.length === 0) {
                    container.innerHTML = '<p class="text-muted">Tidak ada listing untuk filter tersebut</p>';
                    return;
                }

                container.innerHTML = filtered.map(listing => `
                    <div class="listing-card mb-3">
                        <div class="row g-0">
                            <div class="col-md-3">
                                <img src="${listing.image}" class="img-fluid rounded-start h-100 object-fit-cover" alt="${listing.title}">
                            </div>
                            <div class="col-md-9">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h5 class="card-title mb-1">${listing.title} ${listingBadges[listing.id] ? (`<span class="badge bg-info ms-2 text-dark">${listingBadges[listing.id].badge.replace('_',' ')}</span>`) : ''}</h5>
                                            <p class="text-muted small mb-2"><i class="bi bi-person me-1"></i> ${listing.owner_name}</p>
                                        </div>
                                        <span class="status-badge ${listing.status === 'pending' ? 'status-pending' : listing.status === 'approved' ? 'status-approved' : 'status-rejected'}">
                                            ${listing.status}
                                        </span>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Kategori</small>
                                            <span class="badge bg-light text-dark">${listing.category}</span>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Harga</small>
                                            <strong class="text-primary">Rp ${listing.price.toLocaleString('id-ID')}</strong>/bulan
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="showBadgeModal('${listing.id}')">Badge</button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="showFeeModal('${listing.id}')">Set Fee</button>
                                        <a href="listing-detail.html?id=${listing.id}" class="btn btn-outline-primary btn-sm">Lihat</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }, 500);
        }
        
        // Load users
        function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            
            // Mock data - replace with actual API call
            const users = [
                {
                    id: '1',
                    name: 'John Doe',
                    email: 'john@example.com',
                    role: 'user',
                    verified: 1,
                    created_at: '2024-01-15'
                },
                {
                    id: '2',
                    name: 'Jane Smith',
                    email: 'jane@example.com',
                    role: 'host',
                    verified: 0,
                    created_at: '2024-02-20'
                }
            ];
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="badge bg-${user.role === 'host' ? 'primary' : 'secondary'}">${user.role}</span></td>
                    <td>
                        ${user.verified 
                            ? '<span class="badge bg-success">Terverifikasi</span>' 
                            : '<span class="badge bg-warning">Belum Verifikasi</span>'}
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString('id-ID')}</td>
                    <td>
                        ${!user.verified 
                            ? `<button class="btn btn-sm btn-success" onclick="verifyUser('${user.id}')">Verifikasi</button>`
                            : '<small class="text-muted">-</small>'}
                    </td>
                </tr>
            `).join('');
        }
        
        // Verify user
        function verifyUser(userId) {
            if (confirm('Verifikasi user ini?')) {
                notify.success('User berhasil diverifikasi', 'Berhasil!');
                loadUsers();
            }
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

    </script>
</body>
</html>